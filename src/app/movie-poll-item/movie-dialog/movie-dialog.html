<ng-container *ngIf="(movie$ | async); let movie; else pollLoaderItem">
  <div class="dialog-content relative-container" mat-dialog-content>
    <div class="overview">
      <div class="absolute-container">
        <div class="close-button cursor-pointer" (click)="closeDialog()">
          Close
        </div>
      </div>

      <!-- <div class="loading-image backdrop" *ngIf="!backgroundLoaded"></div> -->
      <div #overview></div>
      <ng-container
        *ngIf="{ val: selectedBackdrop$ | async, bg: backdrop$ | async }; let current"
      >
        <div
          class="loading-image backdrop"
          *ngIf="(current.bg === undefined || (backdropLoaded$ | async) === false)"
        ></div>
        <div
          class="backdrop"
          ngSwipe
          (swipeEnd)="onSwipeEnd($event)"
          trapScroll
          [lazyLoad]="current.bg"
          (onStateChange)="onStateChangeBackdropLoaded($event)"
        >
          <div
            class="bd-selectors"
            *ngIf="movie?.originalObject?.images.backdrops.length > 1"
          >
            <div
              *ngFor="let b of movie.originalObject?.images.backdrops.slice(0, maxBgCount); let i = index"
              (click)="selectedBackdrop$.next(i); backdropLoaded$.next(false)"
              class="bd-selector"
              [class.bd-selected]="i === current.val"
            ></div>
          </div>
        </div>
      </ng-container>
      <div class="fade"></div>
      <!-- </div> -->

      <div class="curve-overflow"></div>
      <h1 class="title">
        {{ movie.title }}
        <ng-container
          *ngIf="movie.originalTitle && movie.title !== movie.originalTitle"
          ><span class="original-title"
            >({{ movie.originalTitle }})</span
          ></ng-container
        >
      </h1>
      <div class="subtitle">
        <div
          class="extra-info"
          *ngIf="movie?.originalObject; else movieSubtitleLoader"
        >
          <span class="director">{{ movie | credit:'directors' }}</span>
          <span class="separator">|</span>
          <span class="country-of-origin"
            >{{ movie | productionCountry }}
          </span>
        </div>
        <div class="basics" *ngIf="movie.releaseDate">
          <span class="year">{{ movie.releaseDate | date: "yyyy" }}</span
          ><span class="separator">|</span
          ><span class="runtime">{{ movie.runtime }} min</span>
        </div>
      </div>
      <div class="flex">
        <div class="poster-container">
          <watch-list-marker [movieId]="movie.id"></watch-list-marker>
          <div
            *ngIf="movie.posterPath"
            [lazyLoad]="'https://image.tmdb.org/t/p/w92/' + movie.posterPath"
            class="poster-border"
          ></div>
          <img
            *ngIf="movie.posterPath"
            class="poster fade-in-out"
            [lazyLoad]="'https://image.tmdb.org/t/p/w92' + movie.posterPath + ' 150w,'
                + 'https://image.tmdb.org/t/p/w154' + movie.posterPath + ' 300w,'
                + 'https://image.tmdb.org/t/p/w185' + movie.posterPath + ' 380w,'
                + 'https://image.tmdb.org/t/p/w342' + movie.posterPath + ' 700w,'
                + 'https://image.tmdb.org/t/p/w500' + movie.posterPath + ' 1000w,'
                + 'https://image.tmdb.org/t/p/w780' + movie.posterPath + ' 1400w'"
            [useSrcset]="true"
            [defaultImage]="'/assets/img/poster-placeholder.gif'"
            [errorImage]="'/assets/img/poster-placeholder.png'"
          />

          <movie-score
            class="cursor-pointer"
            (click)="openTmdb(movie.id)"
            [value]="movie.tmdbRating"
            size="m"
          ></movie-score>
          <div class="available-short-container" *ngIf="movie?.originalObject">
            <div
              class="available-short"
              *ngIf="availableShort$ | async; let available"
            >
              <div class="border-frame"></div>
              <div class="flex cursor-pointer" (click)="openAvailable()">
                <div
                  class="watch-provider-image"
                  [title]="available.provider.provider_name"
                  [ngStyle]="{'background-image': available.provider.logo_path ? ('url(https://image.tmdb.org/t/p/' + 'w154/' + available.provider.logo_path + ')') : 'linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)'}"
                ></div>
                <div class="flex-column text">
                  <div class="">{{ available.title }}</div>
                  <div class="label">Check it out!</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex-column movie-details-right">
          <div
            class="credits"
            *ngIf="movie?.originalObject; else movieRightInfoLoader"
          >
            <div
              class="movie-ratings"
              *ngIf="movie?.originalObject; else movieRatingsLoader"
            >
              <!-- <div
              class="movie-rating tmdb cursor-pointer"
              (click)="openTmdb(movie.id)"
              matTooltip="TMDb score"
            >
              <span class="score"
                >{{ movie.tmdbRating | number: '1.1-1' }}</span
              ><mat-icon class="md-16">launch</mat-icon>
            </div> -->
              <div
                *ngIf="movie.imdbRating"
                (click)="openImdb(movie.imdbId)"
                class="movie-rating imdb cursor-pointer"
                matTooltip="IMDb score"
              >
                <span class="score">{{ movie.imdbRating?.split("/")[0] }}</span
                ><mat-icon class="md-16">launch</mat-icon>
              </div>
              <div
                *ngIf="movie.metaRating"
                class="movie-rating meta-critic"
                [ngClass]="movie.metaRating | metaColor"
                matTooltip="Metacritic score"
              >
                <span class="score"
                  >{{ movie.metaRating | number: '1.0' }}</span
                >
              </div>
              <div
                *ngIf="movie.rottenRating"
                class="movie-rating rotten-tomatoes"
                matTooltip="RottenTomatoes score"
              >
                <span class="score">{{ movie.rottenRating }}</span>
              </div>
            </div>
            <ng-container *ngIf="movie?.credits">
              <div class="crew">
                <div class="crew-member">
                  <div class="name">{{ movie | credit: 'directors' }}</div>
                  <div class="job">Director</div>
                </div>
                <div
                  class="crew-member"
                  *ngFor="let member of movie | credit: 'writers':'with-job'"
                >
                  <div class="name">{{ member.name }}</div>
                  <div class="job">{{ member.job }}</div>
                </div>
              </div>
            </ng-container>
          </div>
          <div class="genres">
            <span
              class="genre user-select-none"
              *ngFor="let genre of movie.genres"
            >
              {{ genre }}
            </span>
          </div>
        </div>
      </div>
      <div class="tagline" *ngIf="movie?.originalObject; else taglineLoader">
        <span *ngIf="movie.tagline?.length > 0">"{{ movie.tagline }}"</span>
      </div>
      {{ movie.overview }}
      <ng-container *ngIf="movie.credits?.cast">
        <h2>✨ Starring</h2>
        <div class="cast">
          <div class="cast-member" *ngFor="let member of movie.credits?.cast">
            <div
              class="cast-profile-picture"
              [lazyLoad]="'https://image.tmdb.org/t/p/' + 'w92/' + member.profile_path"
              [errorImage]="'/assets/img/poster-placeholder.png'"
            ></div>
            <div class="name">{{ member.name }}</div>
            <div class="character" [matTooltip]="member.character">
              {{ member.character }}
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="data.description?.length > 0">
        <div class="description" *ngIf="!editDescription">
          "<span [innerHTML]="urlify(data.description)"></span>"
        </div>
      </ng-container>
      <textarea
        *ngIf="data.pollItemId && editDescription !== undefined"
        rows="4"
        [(ngModel)]="editDescription"
      ></textarea>
      <div
        class="description-button cursor-pointer"
        *ngIf="data.editable"
        (click)="descriptionButtonClick(data.pollItem)"
      >
        {{ (editDescription !== data.description && editDescription?.length > 0)
        ? "Save" : (editDescription === data.description &&
        data.description?.length > 0) || editDescription === "" ? 'Cancel' :
        data.description?.length > 0 ? "Edit" : "Add description" }}
      </div>

      <ng-container *ngIf="data.isReactable">
        <div
          class="movie-reactions"
          *ngIf="data.movieReactions$ | async; let movieReactions"
        >
          <ng-container *ngFor="let reaction of movieReactions">
            <div
              (click)="clickReaction(reaction.label)"
              class="reaction cursor-pointer"
              [matTooltipPosition]="'below'"
              [matTooltip]="reaction.tooltip"
              [class.reacted]="reaction.reacted"
              [class.unreacted]="reaction.count === 0"
            >
              <span>{{ translateReactionLabel(reaction.label) }}</span>
              <i
                class="fa-solid user-select-none"
                [class.has-votes]="reaction.count > 0"
                [style.color]="
                  reaction.reacted ? reaction.color : '#black'
                "
                [ngClass]="reaction.label"
              ></i>
              <div class="count" [class.has-votes]="reaction.count > 0">
                {{ reaction.count }}
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>

      <ng-container *ngIf="data.showRecentPollAdder">
        <ng-container *ngIf="recentPolls$ | async; let recentPolls">
          <mat-menu
            #pollSelectMenu="matMenu"
            class="recent-movie-menu"
            xPosition="before"
          >
            <button
              *ngFor="let recentPoll of recentPolls"
              mat-menu-item
              (click)="addOptionToPoll(recentPoll.id)"
            >
              <mat-icon>add_circle_outline</mat-icon>
              <span>{{ recentPoll.name }}</span>
            </button>
          </mat-menu>
          <div [matMenuTriggerFor]="pollSelectMenu" class="add-new-item-btn">
            <mat-icon aria-label="Add new item" class="icon"
              >add_circle_outline</mat-icon
            >Add movie to recent poll
          </div>
        </ng-container>
      </ng-container>

      <mat-accordion>
        <ng-container *ngIf="watchProviders$ | async; let watchProviders">
          <mat-expansion-panel #availablePanel>
            <mat-expansion-panel-header>
              <mat-panel-title
                ><h2 #available>📺 Available</h2></mat-panel-title
              >
            </mat-expansion-panel-header>
            <mat-form-field class="watch-country">
              <!-- <mat-label>Sort</mat-label> -->
              <mat-select [(ngModel)]="selectedWatchProviderCountry">
                <mat-option
                  *ngFor="let country of getWatchProviderCountries(watchProviders)"
                  [value]="country"
                >
                  {{ country | countryFlagName }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <ng-container
              *ngIf="watchProviders.results[selectedWatchProviderCountry]?.flatrate; let flatrate"
            >
              <h4>Subscription</h4>
              <div class="watch-providers">
                <div
                  class="watch-provider flatrate"
                  *ngFor="let provider of flatrate || []"
                >
                  <div
                    class="watch-provider-image"
                    [title]="provider.provider_name"
                    [ngStyle]="{'background-image': provider.logo_path ? ('url(https://image.tmdb.org/t/p/' + 'w154/' + provider.logo_path + ')') : 'linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)'}"
                  ></div>
                  <!-- <div class="name">{{ provider.provider_name }}</div> -->
                </div>
              </div>
            </ng-container>
            <ng-container *ngFor="let method of ['Free', 'Rent', 'Buy', 'Ads']">
              <ng-container
                *ngIf="watchProviders.results[selectedWatchProviderCountry]?.[method.toLowerCase()]; let type"
              >
                <h4>{{ method || titlecase }}</h4>
                <div class="watch-providers">
                  <div
                    class="watch-provider"
                    [ngClass]="{ type }"
                    *ngFor="let provider of type || []"
                  >
                    <div
                      class="watch-provider-image"
                      [ngStyle]="{'background-image': provider.logo_path ? ('url(https://image.tmdb.org/t/p/' + 'w154' + provider.logo_path + ')') : 'linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)'}"
                    ></div>
                    <!-- <div class="name">{{ provider.provider_name }}</div> -->
                  </div>
                </div>
              </ng-container>
            </ng-container>

            <ng-container
              *ngIf="!watchProviders.results[selectedWatchProviderCountry]"
            >
              <div class="not-available">
                <div class="vhs-container">
                  <img
                    class="vhs"
                    [lazyLoad]="'/assets/img/vhs-time.svg'"
                    alt="Graphic of VHS casette in vaporwave style"
                  />
                </div>

                <p>
                  Not available for stream in {{selectedWatchProviderCountry |
                  countryFlagName}}. Maybe 📀?
                </p>
              </div>
            </ng-container>
            <div class="justwatch-credit">
              Provided by <a href="https://www.justwatch.com/">JustWatch</a>
            </div>
          </mat-expansion-panel>
        </ng-container>
        <mat-expansion-panel *ngIf="movie.recommendations?.results.length">
          <mat-expansion-panel-header>
            <mat-panel-title
              ><h2>🍿 You might also like these</h2></mat-panel-title
            >
          </mat-expansion-panel-header>
          <div class="recommendations">
            <div
              class="recommendation"
              *ngFor="let recommendation of movie.recommendations?.results.slice(0, movie.recommendations?.results.length - ((movie.recommendations?.results.length % 3)))"
              (click)="openAnotherMovie(recommendation)"
            >
              <img
                class="recommendation-poster fade-in-out"
                [defaultImage]="'/assets/img/poster-placeholder.gif'"
                [errorImage]="'/assets/img/poster-placeholder.png'"
                [lazyLoad]="'https://image.tmdb.org/t/p/w92' + recommendation.poster_path + ' 300w,'
                + 'https://image.tmdb.org/t/p/w154' + recommendation.poster_path + ' 400w,'
                + 'https://image.tmdb.org/t/p/w185' + recommendation.poster_path + ' 500w,'
                + 'https://image.tmdb.org/t/p/w342' + recommendation.poster_path + ' 700w,'
                + 'https://image.tmdb.org/t/p/w500' + recommendation.poster_path + ' 800w,'
                + 'https://image.tmdb.org/t/p/w780' + recommendation.poster_path + ' 1100w'"
                [useSrcset]="true"
                [offset]="(100 | screenHeight) + 100"
              />
              <movie-score
                class="cursor-pointer"
                (click)="openTmdb(data.movie.id)"
                [value]="recommendation.vote_average"
                size="xs"
              ></movie-score>
              <!-- <div class="recommendation-title">{{ recommendation.title }}</div>
              <div class="recommendation-year">
                ({{ recommendation.release_date | date: "yyyy" }})
              </div> -->
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>

  <div
    mat-dialog-actions
    *ngIf="(data.isVoteable === true || data.addMovie === true) && data.currentMovieOpen !== true"
  >
    <ng-container *ngIf="data.addMovie !== true; else addMovie">
      <div
        class="gradient-button cursor-pointer"
        [ngClass]="{ 'has-voted': data.hasVoted }"
        (click)="voteButtonClick()"
      >
        <mat-icon class="heart-icon">favorite</mat-icon> {{ !data.hasVoted ?
        'Vote' : 'Voted'}}
        <span class="click-to-unvote" *ngIf="data.hasVoted"
          >Re-click to retract vote</span
        >
      </div>
      <div class="voter-list">
        <ng-container *ngIf="data.voteCount"
          >Voters ( {{ data.voteCount }} ): {{ data.voters | voters
          }}</ng-container
        >
      </div>
    </ng-container>
    <ng-template #addMovie>
      <div
        class="gradient-button cursor-pointer"
        (click)="clickAddMovie(movie?.originalObject)"
      >
        <mat-icon class="heart-icon">add</mat-icon> Add movie to {{
        data.parentStr || 'poll'}}
      </div>
    </ng-template>
  </div>
</ng-container>

<ng-template #pollLoaderItem>
  <div class="loading movie-dialog">
    <div class="loading-image backdrop"></div>
    <div class="curve-overflow"></div>
    <div class="movie-dialog-content">
      <div class="flex-column movie-content">
        <div class="flex-column movie-details padding-24">
          <div class="loading-sub-text title"></div>
          <ng-container *ngTemplateOutlet="movieSubtitleLoader"></ng-container>
          <div class="flex poster-with-info">
            <div class="loading-image poster-mockup">
              <div class="loading-movie-score size-m"></div>
            </div>
            <ng-container
              *ngTemplateOutlet="movieRightInfoLoader"
            ></ng-container>
          </div>
          <ng-container *ngTemplateOutlet="taglineLoader"></ng-container>
        </div>
      </div>
    </div>
    <div class="button-container">
      <div class="loading-btn voter-btn"></div>
      <div class="loading-main-text"></div>
    </div>
  </div>
</ng-template>

<ng-template #movieRightInfoLoader>
  <div class="loading movie-dialog">
    <div class="flex-column movie-details-1">
      <div class="flex buttons">
        <div class="loading-btn"></div>
        <div class="loading-btn"></div>
        <div class="loading-btn"></div>
      </div>
      <div class="loading-main-text"></div>
      <div class="loading-main-text"></div>
      <div class="loading-main-text"></div>
      <div class="loading-main-text"></div>
      <div class="loading-main-text"></div>
    </div>
  </div>
</ng-template>

<ng-template #movieSubtitleLoader>
  <div class="loading-main-text sub-title width-75"></div>
  <div class="loading-main-text sub-title width-35"></div>
</ng-template>

<ng-template #taglineLoader>
  <div class="loading-main-text tagline width-75"></div>
  <div class="loading-main-text tagline"></div>
</ng-template>
